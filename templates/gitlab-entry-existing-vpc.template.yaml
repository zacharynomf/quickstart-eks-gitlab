AWSTemplateFormatVersion: 2010-09-09
Description: Deploys a GitLab cluster into an existing VPC. (qs-1rpegts2a)
Metadata:
  QuickStartDocumentation:
    EntrypointName: Launch into an existing VPC
    Order: 2
  LintSpellExclude:
    - BuiltIn
    - dind
    - Gitaly
    - GitLab
    - Praefect
  SentenceCaseExclude:
    - External
    - Multi
    - Performance
    - Runner
    - Tool
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: Basic configuration
        Parameters:
          - EnvironmentName
          - KeyPairName
      - Label:
          default: VPC network configuration
        Parameters:
          - VPCID
          - VPCCIDR
          - PrivateSubnet1ID
          - PrivateSubnet2ID
          - PrivateSubnet3ID
          - PublicSubnet1ID
          - PublicSubnet2ID
          - PublicSubnet3ID
      - Label:
          default: Bastion host configuration
        Parameters:
          - ProvisionBastionHost
          - BastionInstanceType
          - OnDemandBastionPercentage
          - RemoteAccessCIDR
      - Label:
          default: Amazon EKS cluster configuration
        Parameters:
          - EKSPublicAccessEndpoint
          - AdditionalEKSAdminUserArn
          - AdditionalEKSAdminRoleArn
          - NodeInstanceType
          - NodeInstanceFamily
          - OnDemandPercentage
          - NodeVolumeSize
          - NumberOfNodes
          - MaxNumberOfNodes
          - ConfigureContainerInsights
          - ConfigureGrafana
      - Label:
          default: GitLab database configuration
        Parameters:
          - RDSDBInstanceClass
          - DBName
          - DBPraefectName
          - DBUserName
          - DBPort
      - Label:
          default: GitLab cache configuration
        Parameters:
          - CacheMode
          - CacheNodes
          - CacheNodeType
      - Label:
          default: GitLab infrastructure configuration
        Parameters:
          - DomainName
          - PublicDNS
          - PublicHostedZoneId
          - CreateSslCertificate
      - Label:
          default: GitLab SMTP configuration
        Parameters:
          - SMTPDomain
          - SMTPHostName
          - SMTPPort
          - SMTPUsername
          - SMTPPassword
      - Label:
          default: GitLab Helm chart configuration
        Parameters:
          - HelmChartNamespaceCreate
          - HelmChartNamespace
          - HelmChartName
          - GitLabVersion
      - Label:
          default: GitLab Git repository storage configuration
        Parameters:
          - GitalyPraefectInstanceArchitecture
          - NumberOfGitalyReplicas
          - GitalyInstanceType
          - GitalyVolumeSize
          - NumberOfPraefectReplicas
          - PraefectInstanceType
      - Label:
          default: GitLab object storage configuration
        Parameters:
          - ObjectStorageSSEAlgorithm
          - ObjectStorageKMSKeyID
          - BackupSchedule
          - BackupVolumeSize
      - Label:
          default: GitLab Runner configuration
        Parameters:
          - ConfigureRunner
          - RunnerChartName
          - RunnerImage
          - MaximumConcurrentJobs
          - PrivilegedMode
      - Label:
          default: AWS Quick Start configuration
        Parameters:
          - QSS3BucketName
          - QSS3KeyPrefix
          - QSS3BucketRegion
          - PerAccountSharedResources
          - PerRegionSharedResources
    ParameterLabels:
    # Basic configuration
      EnvironmentName:
        default: Environment name
      KeyPairName:
        default: SSH key pair name
    # VPC network configuration
      VPCID:
        default: VPC ID
      VPCCIDR:
        default: VPC CIDR
      PublicSubnet1ID:
        default: Public subnet 1 ID
      PublicSubnet2ID:
        default: Public subnet 2 ID
      PublicSubnet3ID:
        default: Public subnet 3 ID
      PrivateSubnet1ID:
        default: Private subnet 1 ID
      PrivateSubnet2ID:
        default: Private subnet 2 ID
      PrivateSubnet3ID:
        default: Private subnet 3 ID
    # Bastion host configuration
      ProvisionBastionHost:
        default: Provision a bastion host
      BastionInstanceType:
        default: Bastion host instance type
      OnDemandBastionPercentage:
        default: On-demand percentage
      RemoteAccessCIDR:
        default: Allowed bastion external access CIDR
    # Amazon EKS cluster configuration
      EKSPublicAccessEndpoint:
        default: EKS public access endpoint
      AdditionalEKSAdminUserArn:
        default: Additional EKS admin ARN (IAM user)
      AdditionalEKSAdminRoleArn:
        default: Additional EKS admin ARN (IAM role)
      NodeInstanceType:
        default: EKS node instance type
      NodeInstanceFamily:
        default: EKS node instance family
      OnDemandPercentage:
        default: On-demand percentage
      NodeVolumeSize:
        default: EKS node volume capacity
      NumberOfNodes:
        default: Number of EKS nodes
      MaxNumberOfNodes:
        default: Maximum number of EKS nodes
      ConfigureContainerInsights:
        default: Configure Container Insights
      ConfigureGrafana:
        default: Provision and integrate Grafana
    # Database configuration
      RDSDBInstanceClass:
        default: GitLab database instance class
      DBName:
        default: GitLab database name
      DBPraefectName:
        default: Praefect database name
      DBUserName:
        default: Database admin username
      DBPort:
        default: Database port
    # Cache configuration
      CacheMode:
        default: Where to provision Redis
      CacheNodes:
        default: Number of cache replicas
      CacheNodeType:
        default: Cache node type
    # GitLab infrastructure configuration
      DomainName:
        default: GitLab DNS name
      PublicDNS:
        default: Public DNS
      PublicHostedZoneId:
          default: Public hosted Zone ID
      CreateSslCertificate:
        default: Request AWS Certificate Manager SSL certificate
    # GitLab SMTP configuration
      SMTPDomain:
        default: Outgoing SMTP domain
      SMTPHostName:
        default: SMTP server host name
      SMTPPort:
        default: SMTP server port
      SMTPUsername:
        default: SMTP server user name
      SMTPPassword:
        default: SMTP server password
    # GitLab Helm chart configuration
      HelmChartNamespaceCreate:
        default: Kubernetes namespace creation mode
      HelmChartNamespace:
        default: Kubernetes namespace for GitLab Helm chart
      HelmChartName:
        default: GitLab Helm chart name
      GitLabVersion:
        default: GitLab application version
    # GitLab Git repository storage configuration
      GitalyPraefectInstanceArchitecture:
        default: Architecture of Gitaly and Praefect instances
      GitalyInstanceType:
        default: Gitaly instance type
      NumberOfGitalyReplicas:
        default: Number of Gitaly replicas
      GitalyVolumeSize:
        default: Gitaly volume capacity
      NumberOfPraefectReplicas:
        default: Number of Praefect replicas
      PraefectInstanceType:
        default: Praefect instance type
    # GitLab object storage configuration
      ObjectStorageSSEAlgorithm:
        default: Object storage encryption algorithm
      ObjectStorageKMSKeyID:
        default: KMS key ID
      BackupSchedule:
        default: Object storage backup schedule
      BackupVolumeSize:
        default: Object storage backup volume capacity
    # GitLab Runner configuration
      ConfigureRunner:
        default: Configure GitLab Runner
      RunnerChartName:
        default: GitLab Runner Helm chart name
      RunnerImage:
        default: Default runner image
      MaximumConcurrentJobs:
        default: Max number of concurrent jobs
      PrivilegedMode:
        default: Use privileged mode
    # AWS Quick Start configuration
      QSS3BucketName:
        default: Quick Start S3 bucket name
      QSS3BucketRegion:
        default: Quick Start S3 bucket region
      QSS3KeyPrefix:
        default: Quick Start S3 key prefix
      PerAccountSharedResources:
        default: Per-account shared resources
      PerRegionSharedResources:
        default: Per-Region shared resources

Parameters:

# Basic Configuration
  EnvironmentName:
    Type: String
    Description: >-
      Name of the GitLab environment (leave empty to use dynamically generated
      name). Environment name is used to generate unique resource names.
      Multiple GitLab environments with different names can be deployed in the
      same region.
    Default: ''
  KeyPairName:
  # NOTE: Don't change the type of KeyPairName parameter back to
  # AWS::EC2::KeyPair::KeyName. String type is intentional as it enables
  # default (empty) value. By using defaults, we promote
  # AWS Systems Manager Session Manager service, which is a recommended way
  # to connect to EC2 instances.
    Type: String
    Description: >-
      Name of an existing key pair, which allows you to securely connect to
      your instance after it launches. Leave empty to proceed without a key
      pair. You would need to use AWS Systems Manager Session Manager to
      connect to the provisioned EC2 instances.
    Default: ''

# VPC parameters
  VPCID:
    Type: AWS::EC2::VPC::Id
    Description: ID of your existing VPC (e.g., vpc-0343606e).
  VPCCIDR:
    Type: String
    Description: CIDR block for the VPC.
    AllowedPattern: ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/(1[6-9]|2[0-8]))$
    ConstraintDescription: >-
      CIDR block parameter must be in the form x.x.x.x/16-28.
  PublicSubnet1ID:
    Type: AWS::EC2::Subnet::Id
    Description: >-
      ID of the public subnet in Availability Zone 1 of your existing VPC
      (example: subnet-a0246ccd).
  PublicSubnet2ID:
    Type: AWS::EC2::Subnet::Id
    Description: >-
      ID of the public subnet in Availability Zone 2 of your existing VPC
      (example: subnet-b1236eea).
  PublicSubnet3ID:
    Type: String
    Description: >-
      ID of the public subnet in Availability Zone 3 of your existing VPC
      (example: subnet-c3456aba).
    Default: ''
  PrivateSubnet1ID:
    Type: AWS::EC2::Subnet::Id
    Description: >-
      ID of the private subnet in Availability Zone 1 of your existing VPC
      (example: subnet-fe9a8b32).
  PrivateSubnet2ID:
    Type: AWS::EC2::Subnet::Id
    Description: >-
      ID of the private subnet in Availability Zone 2 of your existing VPC
      (example: subnet-be8b01ea).
  PrivateSubnet3ID:
    Type: String
    Description: >-
      ID of the private subnet in Availability Zone 3 of your existing VPC
      (example: subnet-abd39039).
    Default: ''

# Bastion parameters
  ProvisionBastionHost:
    Type: String
    Description: >-
      Choose 'Enabled' to provision a bastion host to access EKS cluster.
      Bastion host includes kubectl and helm tools already configured for EKS
      cluster access. Bastion host is recommended for EKS cluster management in
      production environments as a more secure option than a public EKS API
      endpoint. Select a larger instance size to do performance testing from
      the bastion host using GitLab Performance Tool (GPT).
    AllowedValues: [Enabled, Disabled]
    Default: Disabled
  BastionInstanceType:
    Type: String
    Description: >-
      Instance type for the bastion host. Select an instance from this list:
      https://aws.amazon.com/ec2/instance-types/.
    Default: t3.micro
  OnDemandBastionPercentage:
    Type: Number
    Description: >-
      Set the percentage of on-demand instances and spot instances. With a
      default of 100, the percentages are 100% for on-demand instances and 0%
      for spot instances.
    MinValue: 0
    MaxValue: 100
    Default: 100
  RemoteAccessCIDR:
    Type: String
    Description: >-
      Trusted IPv4 CIDR block that is permitted remote access to your instances
      if desired in addition to AWS Systems Manager (SSM) access.
    AllowedPattern: ^(disabled-onlyssmaccess|(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/([0-9]|[1-2][0-9]|3[0-2])))$
    ConstraintDescription: >-
      CIDR block parameter must be disabled-onlyssmaccess or in the form
      x.x.x.x/x.
    Default: disabled-onlyssmaccess

# Cluster parameters
  EKSPublicAccessEndpoint:
    Type: String
    Description: >-
      Configure access to the Kubernetes API server endpoint from outside of
      your VPC. Public API endpoint is not recommended for production
      environments. Use bastion host for cluster management instead.
    AllowedValues: [Enabled, Disabled]
    Default: Disabled
  AdditionalEKSAdminUserArn:
    Type: String
    Description: >-
      (Optional) IAM user Amazon Resource Name (ARN) to be granted
      administrative access to the EKS cluster.
    Default: ''
  AdditionalEKSAdminRoleArn:
    Type: String
    Description: >-
      (Optional) IAM role Amazon Resource Name (ARN) to be granted
      administrative access to the EKS cluster.
    Default: ''
  NodeInstanceType:
    Type: String
    Description: EC2 instance type of EKS nodes.
    AllowedValues: [
      c1.medium, c1.xlarge,
      c3.large, c3.xlarge, c3.2xlarge, c3.4xlarge, c3.8xlarge,
      c4.large, c4.xlarge, c4.2xlarge, c4.4xlarge, c4.8xlarge,
      c5.large, c5.xlarge, c5.2xlarge, c5.4xlarge, c5.9xlarge, c5.12xlarge, c5.18xlarge, c5.24xlarge, c5.metal,
      c5a.large, c5a.xlarge, c5a.2xlarge, c5a.4xlarge, c5a.8xlarge, c5a.12xlarge, c5a.16xlarge, c5a.24xlarge,
      c5ad.large, c5ad.xlarge, c5ad.2xlarge, c5ad.4xlarge, c5ad.8xlarge, c5ad.12xlarge, c5ad.16xlarge, c5ad.24xlarge,
      c5d.large, c5d.xlarge, c5d.2xlarge, c5d.4xlarge, c5d.9xlarge, c5d.12xlarge, c5d.18xlarge, c5d.24xlarge, c5d.metal,
      c5n.large, c5n.xlarge, c5n.2xlarge, c5n.4xlarge, c5n.9xlarge, c5n.18xlarge, c5n.metal,
      c6a.large, c6a.xlarge, c6a.4xlarge, c6a.8xlarge, c6a.12xlarge, c6a.16xlarge, c6a.24xlarge, c6a.2xlarge, c6a.32xlarge, c6a.48xlarge, c6a.metal,
      c6i.large, c6i.xlarge, c6i.2xlarge, c6i.4xlarge, c6i.8xlarge, c6i.12xlarge, c6i.16xlarge, c6i.24xlarge, c6i.32xlarge, c6i.metal,
      c6id.large, c6id.xlarge, c6id.2xlarge, c6id.4xlarge, c6id.8xlarge, c6id.12xlarge, c6id.16xlarge, c6id.24xlarge, c6id.32xlarge, c6id.metal,
      cc1.4xlarge,
      cc2.8xlarge,
      cr1.8xlarge,
      d2.xlarge, d2.2xlarge, d2.4xlarge, d2.8xlarge,
      d3.xlarge, d3.2xlarge, d3.4xlarge, d3.8xlarge,
      d3en.xlarge, d3en.2xlarge, d3en.4xlarge, d3en.6xlarge, d3en.8xlarge, d3en.12xlarge,
      dl1.24xlarge, f1.2xlarge, f1.4xlarge, f1.16xlarge,
      h1.2xlarge, h1.4xlarge, h1.8xlarge, h1.16xlarge,
      hi1.4xlarge,
      hpc6a.48xlarge, hpc6id.32xlarge,
      hs1.8xlarge,
      i2.xlarge, i2.2xlarge, i2.4xlarge, i2.8xlarge,
      i3.large, i3.xlarge, i3.2xlarge, i3.4xlarge, i3.8xlarge, i3.16xlarge, i3.metal,
      i3en.large, i3en.xlarge, i3en.2xlarge, i3en.3xlarge, i3en.6xlarge, i3en.12xlarge, i3en.24xlarge, i3en.metal,
      i4i.16xlarge, i4i.2xlarge, i4i.32xlarge, i4i.4xlarge, i4i.8xlarge, i4i.large, i4i.metal,
      i4i.xlarge,
      m1.small, m1.medium, m1.large, m1.xlarge,
      m2.xlarge, m2.2xlarge, m2.4xlarge,
      m3.medium, m3.large, m3.xlarge, m3.2xlarge,
      m4.large, m4.xlarge, m4.2xlarge, m4.4xlarge, m4.10xlarge, m4.16xlarge,
      m5.large, m5.xlarge, m5.2xlarge, m5.4xlarge, m5.8xlarge, m5.12xlarge, m5.16xlarge, m5.24xlarge, m5.metal,
      m5a.large, m5a.xlarge, m5a.2xlarge, m5a.4xlarge, m5a.8xlarge, m5a.12xlarge, m5a.16xlarge, m5a.24xlarge,
      m5ad.large, m5ad.xlarge, m5ad.2xlarge, m5ad.4xlarge, m5ad.8xlarge, m5ad.12xlarge, m5ad.16xlarge, m5ad.24xlarge,
      m5d.large, m5d.xlarge, m5d.2xlarge, m5d.4xlarge, m5d.8xlarge, m5d.12xlarge, m5d.16xlarge, m5d.24xlarge, m5d.metal,
      m5dn.large, m5dn.xlarge, m5dn.2xlarge, m5dn.4xlarge, m5dn.8xlarge, m5dn.12xlarge, m5dn.16xlarge, m5dn.24xlarge, m5dn.metal,
      m5n.large, m5n.xlarge, m5n.2xlarge, m5n.4xlarge, m5n.8xlarge, m5n.12xlarge, m5n.16xlarge, m5n.24xlarge, m5n.metal,
      m5zn.large, m5zn.xlarge, m5zn.2xlarge, m5zn.3xlarge, m5zn.6xlarge, m5zn.12xlarge, m5zn.metal,
      m6a.large, m6a.xlarge, m6a.2xlarge, m6a.4xlarge, m6a.8xlarge, m6a.12xlarge, m6a.16xlarge, m6a.24xlarge, m6a.32xlarge, m6a.48xlarge, m6a.metal,
      m6i.large, m6i.xlarge, m6i.2xlarge, m6i.4xlarge, m6i.8xlarge, m6i.12xlarge, m6i.16xlarge, m6i.24xlarge, m6i.32xlarge, m6i.metal,
      m6id.large, m6id.xlarge, m6id.2xlarge, m6id.4xlarge, m6id.8xlarge, m6id.12xlarge, m6id.16xlarge, m6id.24xlarge, m6id.32xlarge, m6id.metal,
      r3.large, r3.xlarge, r3.2xlarge, r3.4xlarge, r3.8xlarge,
      r4.large, r4.xlarge, r4.2xlarge, r4.4xlarge, r4.8xlarge, r4.16xlarge,
      r5.large, r5.xlarge, r5.2xlarge, r5.4xlarge, r5.8xlarge, r5.12xlarge, r5.16xlarge, r5.24xlarge, r5.metal,
      r5a.large, r5a.xlarge, r5a.2xlarge, r5a.4xlarge, r5a.8xlarge, r5a.12xlarge, r5a.16xlarge, r5a.24xlarge,
      r5ad.large, r5ad.xlarge, r5ad.2xlarge, r5ad.4xlarge, r5ad.8xlarge, r5ad.12xlarge, r5ad.16xlarge, r5ad.24xlarge,
      r5b.large, r5b.xlarge, r5b.2xlarge, r5b.4xlarge, r5b.8xlarge, r5b.12xlarge, r5b.16xlarge, r5b.24xlarge, r5b.metal,
      r5d.large, r5d.xlarge, r5d.2xlarge, r5d.4xlarge, r5d.8xlarge, r5d.12xlarge, r5d.16xlarge, r5d.24xlarge, r5d.metal,
      r5dn.large, r5dn.xlarge, r5dn.2xlarge, r5dn.4xlarge, r5dn.8xlarge, r5dn.12xlarge, r5dn.16xlarge, r5dn.24xlarge, r5dn.metal,
      r5n.large, r5n.xlarge, r5n.2xlarge, r5n.4xlarge, r5n.8xlarge, r5n.12xlarge, r5n.16xlarge, r5n.24xlarge, r5n.metal,
      r6a.large, r6a.xlarge, r6a.2xlarge, r6a.4xlarge, r6a.8xlarge, r6a.12xlarge, r6a.16xlarge, r6a.24xlarge, r6a.32xlarge, r6a.48xlarge, r6a.metal,
      r6ad.large, r6ad.xlarge, r6ad.2xlarge, r6ad.4xlarge, r6ad.8xlarge, r6ad.12xlarge, r6ad.16xlarge, r6ad.24xlarge, r6ad.32xlarge, r6ad.48xlarge, r6ad.metal,
      r6i.large, r6i.xlarge, r6i.2xlarge, r6i.4xlarge, r6i.8xlarge, r6i.12xlarge, r6i.16xlarge, r6i.24xlarge, r6i.32xlarge, r6i.metal,
      r6id.large, r6id.xlarge, r6id.2xlarge, r6id.4xlarge, r6id.8xlarge, r6id.12xlarge, r6id.16xlarge, r6id.24xlarge, r6id.32xlarge, r6id.metal,
      t1.micro,
      t2.nano, t2.micro, t2.small, t2.medium, t2.large, t2.xlarge, t2.2xlarge,
      t3.nano, t3.micro, t3.small, t3.medium, t3.large, t3.xlarge, t3.2xlarge,
      t3a.nano, t3a.micro, t3a.small, t3a.medium, t3a.large, t3a.xlarge, t3a.2xlarge,
      u-6tb1.56xlarge, u-6tb1.112xlarge, u-6tb1.metal,
      u-9tb1.112xlarge, u-9tb1.metal,
      u-12tb1.112xlarge, u-12tb1.metal,
      u-18tb1.metal,
      u-24tb1.metal,
      x1.16xlarge, x1.32xlarge,
      x1e.xlarge, x1e.2xlarge, x1e.4xlarge, x1e.8xlarge, x1e.16xlarge, x1e.32xlarge,
      x2idn.16xlarge, x2idn.24xlarge, x2idn.32xlarge, x2idn.metal,
      x2iedn.xlarge, x2iedn.2xlarge, x2iedn.4xlarge, x2iedn.8xlarge, x2iedn.16xlarge, x2iedn.24xlarge, x2iedn.32xlarge, x2iedn.metal,
      x2iezn.2xlarge, x2iezn.4xlarge, x2iezn.6xlarge, x2iezn.8xlarge, x2iezn.12xlarge, x2iezn.metal,
      z1d.large, z1d.xlarge, z1d.2xlarge, z1d.3xlarge, z1d.6xlarge, z1d.12xlarge, z1d.metal
    ]
    ConstraintDescription: Must be a valid EC2 instance type.
    Default: t3.large
  NodeInstanceFamily:
    Type: String
    Description: >-
      Choose the instance family to match the value of "Node instance type".
    AllowedValues: [Standard]
    Default: Standard
  OnDemandPercentage:
    Type: Number
    Description: >-
      Set the percentage of on-demand instances and spot instances. With a
      default of 100, the percentages are 100% for on-demand instances and 0%
      for spot instances.
    MinValue: 0
    MaxValue: 100
    Default: 100
  NodeVolumeSize:
    Type: Number
    Description: >-
      Capacity of EBS volume used by EKS nodes, in GB. Note that in default
      configuration no GitLab data is stored on EBS volumes.
    MinValue: 20
    Default: 100
  NumberOfNodes:
    Type: Number
    Description: >-
      Number of Amazon EKS node instances. Should have a minimum value matching
      the number of Availability Zones configured for GitLab deployment.
    Default: 3
  MaxNumberOfNodes:
    Type: Number
    Description: >-
      Maximum number of Amazon EKS node instances. The default is three.
    Default: 6
  ConfigureContainerInsights:
    Type: String
    Description: >-
      Choose 'No' to disable integration with CloudWatch Container Insights.
      Container insights ensure pod performance metrics and logs are collected
      to CloudWatch - including Gitlab application logs.
    AllowedValues: ['Yes', 'No']
    Default: 'Yes'
  ConfigureGrafana:
    Type: String
    Description: >-
      Choose 'Yes' to provision Grafana to EKS and enable GitLab integration
      with it.
    AllowedValues: ['Yes', 'No']
    Default: 'No'

# Database Parameters
  RDSDBInstanceClass:
    Type: String
    Description: >-
      The name of the compute and memory capacity class of the database
      instance. This Quick Start deploys Multi-AZ Postgres replicas in
      different Availability Zones. The instance class is applied to both
      primary and standby instances. The instance class you choose must support
      the needed PostgreSQL version:
      https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/Concepts.DBInstanceClass.html.
    AllowedPattern: ^db\.[a-z0-9]+\.[a-z0-9]+$
    Default: db.r6g.large
  DBName:
    Type: String
    Description: Name of the GitLab Postgres database.
    MinLength: 0
    MaxLength: 64
    AllowedPattern: ^[a-zA-Z0-9]*$
    ConstraintDescription: Must be a valid name.
    Default: gitlab
  DBPraefectName:
    Type: String
    Description: Name of the Praefect Postgres database.
    MinLength: 0
    MaxLength: 64
    AllowedPattern: ^[a-zA-Z0-9]*$
    ConstraintDescription: Must be a valid name.
    Default: praefect
  DBUserName:
    Type: String
    Description: The database admin account username.
    MinLength: 1
    MaxLength: 16
    AllowedPattern: ^[a-zA-Z][a-zA-Z0-9]*$
    ConstraintDescription: >-
      Must begin with a letter and contain only alphanumeric characters.
    Default: gitlab
  DBPort:
    Type: Number
    Description: The port the instance will listen for connections on.
    ConstraintDescription: Must be in the range [1115-65535].
    MinValue: 1150
    MaxValue: 65535
    Default: 5432

# Cache Parameters
  CacheMode:
    Type: String
    Description: >-
      'BuiltIn' will install Redis in the EKS cluster while 'External'
      provisions Amazon ElastiCache Redis. GitLab Redis in Kubernetes clusters
      is not GitLab reference architecture compliant and only for training or
      testing setups.
    AllowedValues: [BuiltIn, External]
    Default: External
  CacheNodes:
    Type: Number
    Description: >-
      Provide the number of cache replicas (applicable for both BuiltIn and
      External cache modes). For BuiltIn cache mode this is the number of
      replica Redis pods (in addition to primary pod). For External mode this
      is the total number of nodes used for Redis. This should match the number
      of Availability Zones you are configuring for.
    MinValue: 2
    Default: 2
  CacheNodeType:
    Type: String
    Description: >-
      If you chose to use external cache above, provide cache node type. List
      of acceptable instance types:
      https://aws.amazon.com/elasticache/pricing/.
    AllowedPattern: ^cache\.[a-z0-9]+\.[a-z0-9]+$
    Default: cache.t3.medium

# Infra Parameters
  DomainName:
    Type: String
    Description: The domain name for the GitLab server.
  PublicDNS:
    Type: String
    Description: >-
      Choose 'UseExisting' to provide public hosted zone ID where GitLab DNS
      records should be created. Choose 'CreateNew' to provision a new Route 53
      public hosted zone with provided domain name and create GitLab DNS
      records there.
    AllowedValues: [Disabled, UseExisting, CreateNew]
    Default: Disabled
  PublicHostedZoneId:
    Type: String
    Description: >-
      Provide Route 53 public hosted zone ID if you selected 'UseExisting'
      above.
    Default: ''
  CreateSslCertificate:
    Type: String
    Description: >-
      Choose 'Yes' if you want to request AWS Certificate Manager SSL
      certificate for GitLab domain.
    AllowedValues: ['Yes', 'No']
    Default: 'No'

# SMTP Parameters
  SMTPDomain:
    Type: String
    Description: >-
      Choose 'CreateNew' if you want to create Amazon Simple Email Service
      domain to send out GitLab notification email messages.
    AllowedValues: [Disabled, CreateNew, UseExisting]
    Default: Disabled
  SMTPHostName:
    Type: String
    Description: >-
      If you chose to use existing SMTP domain above, provide SMTP server host
      name.
    Default: ''
  SMTPPort:
    Type: Number
    Description: >-
      If you chose to use existing SMTP domain above, provide SMTP server port.
    Default: 587
  SMTPUsername:
    Type: String
    Description: >-
      If you chose to use existing SMTP domain above, provide SMTP server
      username.
    Default: ''
  SMTPPassword:
    Type: String
    Description: >-
      If you chose to use existing SMTP domain above, provide SMTP server
      password.
    Default: ''

# GitLab Helm chart Parameters
  HelmChartNamespaceCreate:
    Type: String
    Description: >-
      Create new or use existing Kubernetes namespace for GitLab chart
      deployment.
    AllowedValues: [CreateNew, UseExisting]
    Default: CreateNew
  HelmChartNamespace:
    Type: String
    Description: Kubernetes namespace to deploy GitLab chart to.
    Default: gitlab
  HelmChartName:
    Type: String
    Description: Name of Helm GitLab deployment.
    Default: gitlab
  GitLabVersion:
    Type: String
    Description: Version of GitLab application.
    AllowedValues:
      # Mapped RDSDBEngineVersion is deprecated
      # - 13.1.11
      # - 13.2.10
      # - 13.3.9
      # - 13.4.7
      # - 13.5.7
      # - 13.6.7
      # - 13.7.9
      # - 13.8.8
      # - 13.9.7
      # - 13.10.5
      # - 13.11.7
      # - 13.12.15
      - 14.2.7
      - 14.3.6
      - 14.4.5
      - 14.5.4
      - 14.6.7
      - 14.7.7
      - 14.8.6
      - 14.9.5
      - 14.10.5
      - 15.1.6
      - 15.2.5
      - 15.3.5
      - 15.4.6
    ConstraintDescription: >-
      Only GitLab versions 13.1-12, 14.2-10, and 15.1-4 are currently tested
      and supported.
    Default: 14.10.5

# Gitaly Storage Parameters
  GitalyPraefectInstanceArchitecture:
    Type: String
    Description: >-
      Pick x86_64 or arm64. Architecture of both GitalyInstanceType and
      PraefectInstanceType must match this arch value. NOTE: ARM for
      Amazon Linux is not supported before GitLab 14.9.0 and this stack will
      fail if that combination is specified.
    AllowedValues: [x86_64, arm64]
    Default: x86_64
  NumberOfGitalyReplicas:
    Type: Number
    Description: >-
      Number of Gitaly replicas to deploy in GitLab cluster. The replicas will
      be distributed across Availability Zones selected.
    AllowedValues: [3]
    Default: 3
  GitalyInstanceType:
    Type: String
    Description: >-
      Gitaly EC2 instance type. Select an instance from this list:
      https://aws.amazon.com/ec2/instance-types/.
    Default: t3.medium
  GitalyVolumeSize:
    Type: Number
    Description: >-
      Capacity of EBS volume used by Gitaly replicas (Git repository storage),
      in GB. Note that this storage is used for Git repositories only. All
      other GitLab storage types are stored in S3 buckets.
    MinValue: 50
    Default: 50
  NumberOfPraefectReplicas:
    Type: Number
    Description: >-
      Praefect coordinates Gitaly cluster replication. Number of Praefect
      replicas to deploy in GitLab cluster. The replicas will be distributed
      across Availability Zones selected.
    AllowedValues: [3]
    Default: 3
  PraefectInstanceType:
    Type: String
    Description: >-
      Praefect EC2 instance type. Select an instance from this list:
      https://aws.amazon.com/ec2/instance-types/.
    Default: t3.medium

# Object Storage Parameters
  ObjectStorageSSEAlgorithm:
    Type: String
    Description: >-
      GitLab will be configured to use object storage for everything that is
      capable of using it (artifacts, packages, LFS, et cetera). Encryption
      algorithm for GitLab object storage artifacts.
    AllowedValues: [AES256]
    Default: AES256
  ObjectStorageKMSKeyID:
    Type: String
    Description: >-
      Provide KMS key ID to be used for encryption if KMS encryption is
      selected.
    AllowedPattern: ^[0-9a-f]{8}\b-[0-9a-f]{4}\b-[0-9a-f]{4}\b-[0-9a-f]{4}\b-[0-9a-f]{12}|$
    ConstraintDescription: Must be a valid KMS key ID.
    Default: ''
  BackupSchedule:
    Type: String
    Description: >-
      Cron expression that is used to run GitLab backup jobs (default is daily
      at 1am).
    Default: 0 1 * * *
  BackupVolumeSize:
    Type: Number
    Description: Capacity of EBS volume used for GitLab backups, in GB.
    MinValue: 10
    Default: 10

# GitLab Runner Parameters
  ConfigureRunner:
    Type: String
    Description: >-
      Choose 'Yes' to enable deployment of test GitLab Runner inside the
      Amazon EKS cluster.
    AllowedValues: ['Yes', 'No']
    Default: 'No'
  RunnerChartName:
    Type: String
    Description: Name of Helm GitLab Runner deployment.
    Default: runner
  RunnerImage:
    Type: String
    Description: Default GitLab Runner image.
    Default: public.ecr.aws/gitlab/gitlab-runner
  MaximumConcurrentJobs:
    Type: Number
    Description: The maximum number of concurrent jobs.
    Default: 10
  PrivilegedMode:
    Type: String
    Description: >-
      Choose 'Yes' to run all containers with the privileged flag enabled.
      This will allow the docker:dind image to run if you need to run Docker.
      For test purposes only. Not recommended for production environments.
    AllowedValues: ['Yes', 'No']
    Default: 'No'

# Quickstart location parameters
  QSS3BucketName:
    Type: String
    Description: >-
      S3 bucket name for the Quick Start assets. This string can include
      numbers, lowercase letters, and hyphens (-). It cannot start or end with
      a hyphen (-).
    AllowedPattern: ^[0-9a-z]+([0-9a-z-]*[0-9a-z])*$
    ConstraintDescription: >-
      Quick Start bucket name can include numbers, lowercase letters, and
      hyphens (-). It cannot start or end with a hyphen (-).
    Default: aws-quickstart
  QSS3BucketRegion:
    Type: String
    Description: >-
      The AWS Region where the Quick Start S3 bucket (QSS3BucketName) is
      hosted. When using your own bucket, you must specify this value.
    Default: us-east-1
  QSS3KeyPrefix:
    Type: String
    Description: >-
      S3 key prefix for the Quick Start assets. Quick Start key prefix can
      include numbers, lowercase letters, uppercase letters, hyphens (-), and
      forward slash (/).
    AllowedPattern: ^([0-9a-zA-Z-.]+/)*$
    ConstraintDescription: >-
      Quick Start key prefix can include numbers, lowercase letters, uppercase
      letters, hyphens (-), and forward slash (/).
    Default: quickstart-eks-gitlab/
  PerAccountSharedResources:
    Type: String
    Description: >-
      Choose 'No' if you already deployed another EKS Quick Start stack in your
      AWS account.
    AllowedValues: [AutoDetect, 'Yes', 'No']
    Default: AutoDetect
  PerRegionSharedResources:
    Type: String
    Description: >-
      Choose 'No' if you already deployed another EKS Quick Start stack in your
      Region.
    AllowedValues: [AutoDetect, 'Yes', 'No']
    Default: AutoDetect

Conditions:
  UsingDefaultBucket: !Equals [!Ref QSS3BucketName, aws-quickstart]
  UsingSpotNodeGroups: !Not [!Equals [!Ref OnDemandPercentage, 100]]
  EmptyEnvironmentName: !Equals [!Ref EnvironmentName, '']
  UsingArmBastion: !Or
    - !Equals [!Ref BastionInstanceType, t4g.nano]
    - !Equals [!Ref BastionInstanceType, t4g.micro]
    - !Equals [!Ref BastionInstanceType, t4g.small]
    - !Equals [!Ref BastionInstanceType, t4g.medium]
    - !Equals [!Ref BastionInstanceType, t4g.large]
    - !Equals [!Ref BastionInstanceType, t4g.xlarge]
    - !Equals [!Ref BastionInstanceType, t4g.2xlarge]

Resources:

  # https://aws-quickstart.github.io/quickstart-amazon-eks/#_configure_advanced_options
  EKSConfigSet:
    Type: AWS::CloudFormation::Stack
    UpdateReplacePolicy: Retain
    DeletionPolicy: Delete
    Properties:
      TemplateURL: !Sub
        - https://${S3Bucket}.s3.${S3Region}.${AWS::URLSuffix}/${QSS3KeyPrefix}submodules/quickstart-amazon-eks/templates/amazon-eks-advanced-configuration.template.yaml
        - S3Region: !If [UsingDefaultBucket, !Ref AWS::Region, !Ref QSS3BucketRegion]
          S3Bucket: !If [UsingDefaultBucket, !Sub '${QSS3BucketName}-${AWS::Region}', !Ref QSS3BucketName]
      Parameters:
        ConfigSetName: !If [EmptyEnvironmentName, !Ref AWS::StackName, !Ref EnvironmentName]
        OnDemandPercentage: !Ref OnDemandPercentage
        NodeVolumeSize: !Ref NodeVolumeSize
        BastionInstanceType: !Ref BastionInstanceType
        BastionOS: !If [UsingArmBastion, Amazon-Linux2-HVM-ARM, Amazon-Linux2-HVM]
        OnDemandBastionPercentage: !Ref OnDemandBastionPercentage
        KubernetesVersion: 1.22

  EKSStack:
    Type: AWS::CloudFormation::Stack
    DependsOn: EKSConfigSet
    UpdateReplacePolicy: Retain
    DeletionPolicy: Delete
    Properties:
      TemplateURL: !Sub
        - https://${S3Bucket}.s3.${S3Region}.${AWS::URLSuffix}/${QSS3KeyPrefix}submodules/quickstart-amazon-eks/templates/amazon-eks-entrypoint-existing-vpc.template.yaml
        - S3Region: !If [UsingDefaultBucket, !Ref AWS::Region, !Ref QSS3BucketRegion]
          S3Bucket: !If [UsingDefaultBucket, !Sub '${QSS3BucketName}-${AWS::Region}', !Ref QSS3BucketName]
      Parameters:
        # Quickstart properties
        QSS3BucketName: !Ref QSS3BucketName
        QSS3KeyPrefix: !Sub ${QSS3KeyPrefix}submodules/quickstart-amazon-eks/
        QSS3BucketRegion: !Ref QSS3BucketRegion
        # VPC properties
        VPCID: !Ref VPCID
        PublicSubnet1ID: !Ref PublicSubnet1ID
        PublicSubnet2ID: !Ref PublicSubnet2ID
        PublicSubnet3ID: !Ref PublicSubnet3ID
        PrivateSubnet1ID: !Ref PrivateSubnet1ID
        PrivateSubnet2ID: !Ref PrivateSubnet2ID
        PrivateSubnet3ID: !Ref PrivateSubnet3ID
        # Cluster properties
        KeyPairName: !Ref KeyPairName
        RemoteAccessCIDR: !Ref RemoteAccessCIDR
        EKSPublicAccessEndpoint: !Ref EKSPublicAccessEndpoint
        ProvisionBastionHost: !Ref ProvisionBastionHost
        AdditionalEKSAdminUserArn: !Ref AdditionalEKSAdminUserArn
        AdditionalEKSAdminRoleArn: !Ref AdditionalEKSAdminRoleArn
        LoadBalancerController: Enabled
        ClusterAutoScaler: Enabled
        MetricsServer: Enabled
        NodeInstanceType: !Ref NodeInstanceType
        NodeInstanceFamily: !Ref NodeInstanceFamily
        NodeGroupType: !If [UsingSpotNodeGroups, Unmanaged, Managed]
        NumberOfNodes: !Ref NumberOfNodes
        MaxNumberOfNodes: !Ref MaxNumberOfNodes
        ConfigSetName: !If [EmptyEnvironmentName, !Ref AWS::StackName, !Ref EnvironmentName]
        PrometheusIntegration: Enabled
        # Shared resources
        PerAccountSharedResources: !Ref PerAccountSharedResources
        PerRegionSharedResources: !Ref PerRegionSharedResources

  GitLabStack:
    Type: AWS::CloudFormation::Stack
    UpdateReplacePolicy: Retain
    DeletionPolicy: Delete
    Properties:
      TemplateURL: !Sub
        - https://${S3Bucket}.s3.${S3Region}.${AWS::URLSuffix}/${QSS3KeyPrefix}templates/workload/gitlab-template.yaml
        - S3Region: !If [UsingDefaultBucket, !Ref AWS::Region, !Ref QSS3BucketRegion]
          S3Bucket: !If [UsingDefaultBucket, !Sub '${QSS3BucketName}-${AWS::Region}', !Ref QSS3BucketName]
      Parameters:
        # Quickstart properties
        QSS3BucketName: !Ref QSS3BucketName
        QSS3KeyPrefix: !Ref QSS3KeyPrefix
        QSS3BucketRegion: !Ref QSS3BucketRegion
        # Infra properties
        DomainName: !Ref DomainName
        PublicDNS: !Ref PublicDNS
        PublicHostedZoneId: !Ref PublicHostedZoneId
        CreateSslCertificate: !Ref CreateSslCertificate
        EnvironmentName: !If [EmptyEnvironmentName, !Ref AWS::StackName, !Ref EnvironmentName]
        # Network properties
        VPCID: !Ref VPCID
        VPCCIDR: !Ref VPCCIDR
        PrivateSubnet1ID: !Ref PrivateSubnet1ID
        PrivateSubnet2ID: !Ref PrivateSubnet2ID
        NodeGroupSecurityGroup: !GetAtt EKSStack.Outputs.NodeGroupSecurityGroup
        # Cluster properties
        KubeClusterName: !GetAtt EKSStack.Outputs.EKSClusterName
        OIDCProviderArn: !GetAtt EKSStack.Outputs.OIDCProviderArn
        OIDCProviderEndpoint: !GetAtt EKSStack.Outputs.OIDCProviderEndpoint
        ConfigureContainerInsights: !Ref ConfigureContainerInsights
        ConfigureGrafana: !Ref ConfigureGrafana
        # Database properties
        RDSDBInstanceClass: !Ref RDSDBInstanceClass
        DBName: !Ref DBName
        DBPraefectName: !Ref DBPraefectName
        DBUserName: !Ref DBUserName
        DBPort: !Ref DBPort
        # Object storage properties
        ObjectStorageSSEAlgorithm: !Ref ObjectStorageSSEAlgorithm
        ObjectStorageKMSKeyID: !Ref ObjectStorageKMSKeyID
        BackupSchedule: !Ref BackupSchedule
        BackupVolumeSize: !Ref BackupVolumeSize
        # Cache properties
        CacheMode: !Ref CacheMode
        CacheNodes: !Ref CacheNodes
        CacheNodeType: !Ref CacheNodeType
        # SMTP properties
        SMTPDomain: !Ref SMTPDomain
        SMTPHostName: !Ref SMTPHostName
        SMTPPort: !Ref SMTPPort
        SMTPUsername: !Ref SMTPUsername
        SMTPPassword: !Ref SMTPPassword
        # Chart properties
        HelmChartNamespaceCreate: !Ref HelmChartNamespaceCreate
        HelmChartNamespace: !Ref HelmChartNamespace
        HelmChartName: !Ref HelmChartName
        GitLabVersion: !Ref GitLabVersion
        # Git repository storage properties
        LatestAmazonLinuxAmi: !Sub /aws/service/ami-amazon-linux-latest/amzn2-ami-hvm-${GitalyPraefectInstanceArchitecture}-gp2
        PraefectInstanceType: !Ref PraefectInstanceType
        GitalyInstanceType: !Ref GitalyInstanceType
        NumberOfPraefectReplicas: !Ref NumberOfPraefectReplicas
        NumberOfGitalyReplicas: !Ref NumberOfGitalyReplicas
        GitalyVolumeSize: !Ref GitalyVolumeSize
        # Runner properties
        ConfigureRunner: !Ref ConfigureRunner
        RunnerChartName: !Ref RunnerChartName
        RunnerImage: !Ref RunnerImage
        MaximumConcurrentJobs: !Ref MaximumConcurrentJobs
        PrivilegedMode: !Ref PrivilegedMode

Rules:
  SMTPParameters:
    RuleCondition: !Equals [!Ref SMTPDomain, UseExisting]
    Assertions:
      - Assert: !Not [!Equals [!Ref SMTPHostName, '']]
        AssertDescription: >-
          You must provide SMTP host name if you chose to use existing SMTP
          server.
  BastionParameters:
    RuleCondition: !Equals [!Ref ProvisionBastionHost, Enabled]
    Assertions:
      - Assert: !Not [!Equals [!Ref RemoteAccessCIDR, '']]
        AssertDescription: >-
          You must provide RemoteAccessCIDR you chose to set
          ProvisionBastionHost to Enabled.
  UnsupportedGitalyPraefectInstanceArchitecture:
    RuleCondition: !Equals [!Ref GitalyPraefectInstanceArchitecture, arm64]
    Assertions:
      - Assert: !Not
          - !Contains
              - - 13.1.11
                - 13.2.10
                - 13.3.9
                - 13.4.7
                - 13.5.7
                - 13.6.7
                - 13.7.9
                - 13.8.8
                - 13.9.7
                - 13.10.5
                - 13.11.7
                - 13.12.15
                - 14.2.7
                - 14.3.6
                - 14.4.5
                - 14.5.4
                - 14.6.7
                - 14.7.7
                - 14.8.6
              - !Ref GitLabVersion
        AssertDescription: >-
          ARM for Amazon Linux is not supported before GitLab 14.9.0.
  ArmInstance:
    RuleCondition: !Equals [!Ref NodeInstanceFamily, ARM]
    Assertions:
      - Assert: !Contains
          - [
              a1.medium, a1.large, a1.xlarge, a1.2xlarge, a1.4xlarge, a1.metal,
              c6g.medium, c6g.large, c6g.xlarge, c6g.2xlarge, c6g.4xlarge, c6g.8xlarge, c6g.12xlarge, c6g.16xlarge, c6g.metal,
              c6gd.medium, c6gd.large, c6gd.xlarge, c6gd.2xlarge, c6gd.4xlarge, c6gd.8xlarge, c6gd.12xlarge, c6gd.16xlarge, c6gd.metal,
              c6gn.medium, c6gn.large, c6gn.xlarge, c6gn.2xlarge, c6gn.4xlarge, c6gn.8xlarge, c6gn.12xlarge, c6gn.16xlarge,
              c7g.medium, c7g.large, c7g.xlarge, c7g.2xlarge, c7g.4xlarge, c7g.8xlarge, c7g.12xlarge, c7g.16xlarge,
              g5g.xlarge, g5g.2xlarge, g5g.4xlarge, g5g.8xlarge, g5g.16xlarge, g5g.metal,
              im4gn.large, im4gn.xlarge, im4gn.2xlarge, im4gn.4xlarge, im4gn.8xlarge, im4gn.16xlarge,
              is4gen.medium, is4gen.large, is4gen.xlarge, is4gen.2xlarge, is4gen.4xlarge, is4gen.8xlarge,
              m6g.medium, m6g.large, m6g.xlarge, m6g.2xlarge, m6g.4xlarge, m6g.8xlarge, m6g.12xlarge, m6g.16xlarge, m6g.metal,
              m6gd.medium, m6gd.large, m6gd.xlarge, m6gd.2xlarge, m6gd.4xlarge, m6gd.8xlarge, m6gd.12xlarge, m6gd.16xlarge, m6gd.metal,
              r6g.medium, r6g.large, r6g.xlarge, r6g.2xlarge, r6g.4xlarge, r6g.8xlarge, r6g.12xlarge, r6g.16xlarge, r6g.metal,
              r6gd.medium, r6gd.large, r6gd.xlarge, r6gd.2xlarge, r6gd.4xlarge, r6gd.8xlarge, r6gd.12xlarge, r6gd.16xlarge, r6gd.metal,
              t4g.nano, t4g.micro, t4g.small, t4g.medium, t4g.large, t4g.xlarge, t4g.2xlarge,
              x2gd.medium, x2gd.large, x2gd.xlarge, x2gd.2xlarge, x2gd.4xlarge, x2gd.8xlarge, x2gd.12xlarge, x2gd.16xlarge, x2gd.metal
            ]
          - !Ref NodeInstanceType
        # Removing list in assertion description to reduce document size.
        AssertDescription: >-
          This option requires an instance type from the ARM family.
          The full list can be found here: https://github.com/aws-quickstart/quickstart-amazon-eks/blob/v5.0.0/templates/amazon-eks-entrypoint-new-vpc.template.yaml#L1076-L1089
  StandardInstance:
    RuleCondition: !Equals [!Ref NodeInstanceFamily, Standard]
    Assertions:
      - Assert: !Contains
          - [
              c1.medium, c1.xlarge,
              c3.large, c3.xlarge, c3.2xlarge, c3.4xlarge, c3.8xlarge,
              c4.large, c4.xlarge, c4.2xlarge, c4.4xlarge, c4.8xlarge,
              c5.large, c5.xlarge, c5.2xlarge, c5.4xlarge, c5.9xlarge, c5.12xlarge, c5.18xlarge, c5.24xlarge, c5.metal,
              c5a.large, c5a.xlarge, c5a.2xlarge, c5a.4xlarge, c5a.8xlarge, c5a.12xlarge, c5a.16xlarge, c5a.24xlarge,
              c5ad.large, c5ad.xlarge, c5ad.2xlarge, c5ad.4xlarge, c5ad.8xlarge, c5ad.12xlarge, c5ad.16xlarge, c5ad.24xlarge,
              c5d.large, c5d.xlarge, c5d.2xlarge, c5d.4xlarge, c5d.9xlarge, c5d.12xlarge, c5d.18xlarge, c5d.24xlarge, c5d.metal,
              c5n.large, c5n.xlarge, c5n.2xlarge, c5n.4xlarge, c5n.9xlarge, c5n.18xlarge, c5n.metal,
              c6a.large, c6a.xlarge, c6a.4xlarge, c6a.8xlarge, c6a.12xlarge, c6a.16xlarge, c6a.24xlarge, c6a.2xlarge, c6a.32xlarge, c6a.48xlarge, c6a.metal,
              c6i.large, c6i.xlarge, c6i.2xlarge, c6i.4xlarge, c6i.8xlarge, c6i.12xlarge, c6i.16xlarge, c6i.24xlarge, c6i.32xlarge, c6i.metal,
              c6id.large, c6id.xlarge, c6id.2xlarge, c6id.4xlarge, c6id.8xlarge, c6id.12xlarge, c6id.16xlarge, c6id.24xlarge, c6id.32xlarge, c6id.metal,
              cc1.4xlarge,
              cc2.8xlarge,
              cr1.8xlarge,
              d2.xlarge, d2.2xlarge, d2.4xlarge, d2.8xlarge,
              d3.xlarge, d3.2xlarge, d3.4xlarge, d3.8xlarge,
              d3en.xlarge, d3en.2xlarge, d3en.4xlarge, d3en.6xlarge, d3en.8xlarge, d3en.12xlarge,
              dl1.24xlarge, f1.2xlarge, f1.4xlarge, f1.16xlarge,
              h1.2xlarge, h1.4xlarge, h1.8xlarge, h1.16xlarge,
              hi1.4xlarge,
              hpc6a.48xlarge, hpc6id.32xlarge,
              hs1.8xlarge,
              i2.xlarge, i2.2xlarge, i2.4xlarge, i2.8xlarge,
              i3.large, i3.xlarge, i3.2xlarge, i3.4xlarge, i3.8xlarge, i3.16xlarge, i3.metal,
              i3en.large, i3en.xlarge, i3en.2xlarge, i3en.3xlarge, i3en.6xlarge, i3en.12xlarge, i3en.24xlarge, i3en.metal,
              i4i.16xlarge, i4i.2xlarge, i4i.32xlarge, i4i.4xlarge, i4i.8xlarge, i4i.large, i4i.metal,
              i4i.xlarge,
              m1.small, m1.medium, m1.large, m1.xlarge,
              m2.xlarge, m2.2xlarge, m2.4xlarge,
              m3.medium, m3.large, m3.xlarge, m3.2xlarge,
              m4.large, m4.xlarge, m4.2xlarge, m4.4xlarge, m4.10xlarge, m4.16xlarge,
              m5.large, m5.xlarge, m5.2xlarge, m5.4xlarge, m5.8xlarge, m5.12xlarge, m5.16xlarge, m5.24xlarge, m5.metal,
              m5a.large, m5a.xlarge, m5a.2xlarge, m5a.4xlarge, m5a.8xlarge, m5a.12xlarge, m5a.16xlarge, m5a.24xlarge,
              m5ad.large, m5ad.xlarge, m5ad.2xlarge, m5ad.4xlarge, m5ad.8xlarge, m5ad.12xlarge, m5ad.16xlarge, m5ad.24xlarge,
              m5d.large, m5d.xlarge, m5d.2xlarge, m5d.4xlarge, m5d.8xlarge, m5d.12xlarge, m5d.16xlarge, m5d.24xlarge, m5d.metal,
              m5dn.large, m5dn.xlarge, m5dn.2xlarge, m5dn.4xlarge, m5dn.8xlarge, m5dn.12xlarge, m5dn.16xlarge, m5dn.24xlarge, m5dn.metal,
              m5n.large, m5n.xlarge, m5n.2xlarge, m5n.4xlarge, m5n.8xlarge, m5n.12xlarge, m5n.16xlarge, m5n.24xlarge, m5n.metal,
              m5zn.large, m5zn.xlarge, m5zn.2xlarge, m5zn.3xlarge, m5zn.6xlarge, m5zn.12xlarge, m5zn.metal,
              m6a.large, m6a.xlarge, m6a.2xlarge, m6a.4xlarge, m6a.8xlarge, m6a.12xlarge, m6a.16xlarge, m6a.24xlarge, m6a.32xlarge, m6a.48xlarge, m6a.metal,
              m6i.large, m6i.xlarge, m6i.2xlarge, m6i.4xlarge, m6i.8xlarge, m6i.12xlarge, m6i.16xlarge, m6i.24xlarge, m6i.32xlarge, m6i.metal,
              m6id.large, m6id.xlarge, m6id.2xlarge, m6id.4xlarge, m6id.8xlarge, m6id.12xlarge, m6id.16xlarge, m6id.24xlarge, m6id.32xlarge, m6id.metal,
              r3.large, r3.xlarge, r3.2xlarge, r3.4xlarge, r3.8xlarge,
              r4.large, r4.xlarge, r4.2xlarge, r4.4xlarge, r4.8xlarge, r4.16xlarge,
              r5.large, r5.xlarge, r5.2xlarge, r5.4xlarge, r5.8xlarge, r5.12xlarge, r5.16xlarge, r5.24xlarge, r5.metal,
              r5a.large, r5a.xlarge, r5a.2xlarge, r5a.4xlarge, r5a.8xlarge, r5a.12xlarge, r5a.16xlarge, r5a.24xlarge,
              r5ad.large, r5ad.xlarge, r5ad.2xlarge, r5ad.4xlarge, r5ad.8xlarge, r5ad.12xlarge, r5ad.16xlarge, r5ad.24xlarge,
              r5b.large, r5b.xlarge, r5b.2xlarge, r5b.4xlarge, r5b.8xlarge, r5b.12xlarge, r5b.16xlarge, r5b.24xlarge, r5b.metal,
              r5d.large, r5d.xlarge, r5d.2xlarge, r5d.4xlarge, r5d.8xlarge, r5d.12xlarge, r5d.16xlarge, r5d.24xlarge, r5d.metal,
              r5dn.large, r5dn.xlarge, r5dn.2xlarge, r5dn.4xlarge, r5dn.8xlarge, r5dn.12xlarge, r5dn.16xlarge, r5dn.24xlarge, r5dn.metal,
              r5n.large, r5n.xlarge, r5n.2xlarge, r5n.4xlarge, r5n.8xlarge, r5n.12xlarge, r5n.16xlarge, r5n.24xlarge, r5n.metal,
              r6a.large, r6a.xlarge, r6a.2xlarge, r6a.4xlarge, r6a.8xlarge, r6a.12xlarge, r6a.16xlarge, r6a.24xlarge, r6a.32xlarge, r6a.48xlarge, r6a.metal,
              r6ad.large, r6ad.xlarge, r6ad.2xlarge, r6ad.4xlarge, r6ad.8xlarge, r6ad.12xlarge, r6ad.16xlarge, r6ad.24xlarge, r6ad.32xlarge, r6ad.48xlarge, r6ad.metal,
              r6i.large, r6i.xlarge, r6i.2xlarge, r6i.4xlarge, r6i.8xlarge, r6i.12xlarge, r6i.16xlarge, r6i.24xlarge, r6i.32xlarge, r6i.metal,
              r6id.large, r6id.xlarge, r6id.2xlarge, r6id.4xlarge, r6id.8xlarge, r6id.12xlarge, r6id.16xlarge, r6id.24xlarge, r6id.32xlarge, r6id.metal,
              t1.micro,
              t2.nano, t2.micro, t2.small, t2.medium, t2.large, t2.xlarge, t2.2xlarge,
              t3.nano, t3.micro, t3.small, t3.medium, t3.large, t3.xlarge, t3.2xlarge,
              t3a.nano, t3a.micro, t3a.small, t3a.medium, t3a.large, t3a.xlarge, t3a.2xlarge,
              u-6tb1.56xlarge, u-6tb1.112xlarge, u-6tb1.metal,
              u-9tb1.112xlarge, u-9tb1.metal,
              u-12tb1.112xlarge, u-12tb1.metal,
              u-18tb1.metal,
              u-24tb1.metal,
              x1.16xlarge, x1.32xlarge,
              x1e.xlarge, x1e.2xlarge, x1e.4xlarge, x1e.8xlarge, x1e.16xlarge, x1e.32xlarge,
              x2idn.16xlarge, x2idn.24xlarge, x2idn.32xlarge, x2idn.metal,
              x2iedn.xlarge, x2iedn.2xlarge, x2iedn.4xlarge, x2iedn.8xlarge, x2iedn.16xlarge, x2iedn.24xlarge, x2iedn.32xlarge, x2iedn.metal,
              x2iezn.2xlarge, x2iezn.4xlarge, x2iezn.6xlarge, x2iezn.8xlarge, x2iezn.12xlarge, x2iezn.metal,
              z1d.large, z1d.xlarge, z1d.2xlarge, z1d.3xlarge, z1d.6xlarge, z1d.12xlarge, z1d.metal
            ]
          - !Ref NodeInstanceType
        # Removing list in assertion description to reduce document size.
        AssertDescription: >-
          Pick a valid instance type from the "Standard" family, i.e., instances not from the GPU or ARM family.
          Full list can be found here: https://github.com/aws-quickstart/quickstart-amazon-eks/blob/v5.0.0/templates/amazon-eks-entrypoint-new-vpc.template.yaml#L1150-L1218
